<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Chatbot - Your AI Financial Advisor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-content">
                <div class="bot-avatar">
                    <i class="fas fa-chart-line"></i>
                    <div class="status-indicator"></div>
                </div>
                <div class="bot-info">
                    <h1 class="bot-name">Investment Advisor AI</h1>
                    <p class="bot-status">
                        <i class="fas fa-circle online-dot"></i>
                        Ready to help with your investment questions
                    </p>
                </div>
                <div class="header-actions">
                    <button class="action-btn" id="clearChat" title="Clear Chat">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button class="action-btn" id="toggleTheme" title="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat Messages Area -->
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <div class="welcome-content">
                    <div class="welcome-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h3>Welcome to Investment Advisor AI!</h3>
                    <p>I'm here to help you with investment advice, market insights, and financial planning. Ask me anything about:</p>
                    <div class="suggestion-chips">
                        <span class="chip" onclick="sendSuggestion('What are the best investment strategies for beginners?')">
                            <i class="fas fa-seedling"></i> Beginner Strategies
                        </span>
                        <span class="chip" onclick="sendSuggestion('How should I diversify my portfolio?')">
                            <i class="fas fa-chart-pie"></i> Portfolio Diversification
                        </span>
                        <span class="chip" onclick="sendSuggestion('What are the current market trends?')">
                            <i class="fas fa-trending-up"></i> Market Trends
                        </span>
                        <span class="chip" onclick="sendSuggestion('Tell me about risk management in investing')">
                            <i class="fas fa-shield-alt"></i> Risk Management
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="typing-content">
                <div class="bot-avatar-small">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span class="typing-text">AI is thinking...</span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input-container">
            <form id="messageForm" class="chat-input-form">
                <div class="input-wrapper">
                    <button type="button" class="attachment-btn" title="Attach File">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input 
                        type="text" 
                        id="messageInput" 
                        name="msg" 
                        placeholder="Ask me about investments, market trends, or financial advice..." 
                        autocomplete="off" 
                        required
                        maxlength="500"
                    />
                    <div class="input-actions">
                        <span class="char-count" id="charCount">0/500</span>
                        <button type="submit" id="sendBtn" class="send-btn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let messageCount = 0;
        let isTyping = false;

        // DOM elements
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatMessages = document.getElementById('chatMessages');
        const typingIndicator = document.getElementById('typingIndicator');
        const charCount = document.getElementById('charCount');
        const clearChatBtn = document.getElementById('clearChat');
        const toggleThemeBtn = document.getElementById('toggleTheme');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            messageInput.focus();
            updateSendButton();
            loadTheme();
        });

        // Message input handling
        messageInput.addEventListener('input', function() {
            updateCharCount();
            updateSendButton();
            autoResize();
        });

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!sendBtn.disabled) {
                    sendMessage();
                }
            }
        });

        // Form submission
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });

        // Clear chat functionality
        clearChatBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear the chat history?')) {
                clearChat();
            }
        });

        // Theme toggle
        toggleThemeBtn.addEventListener('click', toggleTheme);

        // Functions
        function updateCharCount() {
            const count = messageInput.value.length;
            charCount.textContent = `${count}/500`;
            charCount.style.color = count > 450 ? '#ff6b6b' : '';
        }

        function updateSendButton() {
            const hasText = messageInput.value.trim().length > 0;
            sendBtn.disabled = !hasText || isTyping;
        }

        function autoResize() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        function sendMessage() {
            if (isTyping) return;

            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            
            // Clear input
            messageInput.value = '';
            updateCharCount();
            updateSendButton();
            autoResize();

            // Show typing indicator
            showTyping();

            // Send to server
            fetch('/get', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `msg=${encodeURIComponent(message)}`
            })
            .then(response => response.text())
            .then(data => {
                hideTyping();
                addMessage(data, 'bot');
            })
            .catch(error => {
                hideTyping();
                addMessage('Sorry, I encountered an error. Please try again.', 'bot', true);
                console.error('Error:', error);
            });
        }

        function addMessage(content, sender, isError = false) {
            messageCount++;
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.setAttribute('data-message-id', messageCount);

            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-bubble user-bubble">
                            <p>${escapeHtml(content)}</p>
                            <span class="message-time">${time}</span>
                        </div>
                        <div class="message-avatar user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-avatar bot-avatar-small">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="message-bubble bot-bubble ${isError ? 'error-bubble' : ''}">
                            <p>${escapeHtml(content)}</p>
                            <span class="message-time">${time}</span>
                            ${!isError ? '<button class="copy-btn" onclick="copyMessage(this)" title="Copy message"><i class="fas fa-copy"></i></button>' : ''}
                        </div>
                    </div>
                `;
            }

            // Remove welcome message if it exists
            const welcomeMessage = chatMessages.querySelector('.welcome-message');
            if (welcomeMessage) {
                welcomeMessage.remove();
            }

            chatMessages.appendChild(messageDiv);
            scrollToBottom();

            // Add animation
            setTimeout(() => {
                messageDiv.classList.add('message-appear');
            }, 10);
        }

        function showTyping() {
            isTyping = true;
            updateSendButton();
            typingIndicator.style.display = 'flex';
            scrollToBottom();
        }

        function hideTyping() {
            isTyping = false;
            updateSendButton();
            typingIndicator.style.display = 'none';
        }

        function scrollToBottom() {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        function clearChat() {
            chatMessages.innerHTML = `
                <div class="welcome-message">
                    <div class="welcome-content">
                        <div class="welcome-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3>Chat Cleared!</h3>
                        <p>Ready for a fresh conversation. What would you like to know about investing?</p>
                    </div>
                </div>
            `;
            messageCount = 0;
        }

        function sendSuggestion(text) {
            messageInput.value = text;
            updateCharCount();
            updateSendButton();
            sendMessage();
        }

        function copyMessage(btn) {
            const messageText = btn.parentElement.querySelector('p').textContent;
            navigator.clipboard.writeText(messageText).then(() => {
                const originalIcon = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.style.color = '#4CAF50';
                setTimeout(() => {
                    btn.innerHTML = originalIcon;
                    btn.style.color = '';
                }, 2000);
            });
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            const icon = toggleThemeBtn.querySelector('i');
            icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                toggleThemeBtn.querySelector('i').className = 'fas fa-sun';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>